<?
	# 패스 및 클래스
	include $_SERVER[DOCUMENT_ROOT]."/Root_Path.inc";
	include "variable_config.inc";

	# DB 접속 및 함수
	include "logon.inc";
	include "user_function.inc";

	# 변수 및 설정
	include "config.inc";
	include "t_config.inc";

	# 입력값에 대한 타당성 검사
	include "t_checkvalid.inc";
	
	
	include "t.inc";

	# ------------------------------------------------------- #
	#	권한체크
	# ------------------------------------------------------- #
	// 비공개글인경우
	if($my_public_yn == "N" && $cf_top_level_yn != "Y" && (!$cf_cook_id || $cf_cook_id != $my_input_id))
	{
		error_msg("비공개글입니다.\\n\\n수정할 수 있는 권한이 없습니다.", "back");
		exit;
	}

	// 로그인한경우 (최고관리자가 아니고 내글이 아닌경우)
	if($cf_top_level_yn != "Y" && $cf_cook_id && $cf_cook_id != $my_input_id)
	{
		error_msg("수정하실 수 없습니다.", "back");
		exit;
	}

	// 로그인하지 않은경우 승인패스워드가 없거나 승인패스워드와 입력인패스워드가 틀린경우
	if(!$cf_cook_id && (!$my_passwd || $my_passwd && $fr_passwd != $my_passwd))
	{
		error_msg("비밀번호가 일치하지 않습니다.", "back");
		exit;
	}

	

	# ------------------------------------------------------- #
	#	입력값 정리 시작
	# ------------------------------------------------------- #
	// 제목과 본문의 문자열에 포함된 특수문자를 escape시킨다.
	$fr_subject = escape_string($fr_subject);
	$fr_memo = escape_string($fr_memo);

	// HTML 사용여부
	$tm_html_yn = ($fr_html_yn == "Y") ? "Y" : "N";

	// 공개여부
	$tm_public_yn = ($fr_public_yn == "N") ? "N" : "Y";

	// 공지사항여부
	$tm_notice_yn = ($fr_notice_yn == "Y") ? "Y" : "N";
	$tm_notice_yn = ($cf_top_level_yn == "Y") ? $tm_notice_yn : "N";

	# 서비스여부
	if($cf_top_level_yn == "Y" && (!$fr_service_yn || $fr_service_yn == "N"))
		$tm_service_yn = "N";
	else
		$tm_service_yn = "Y";

	// 작성자관련정보 설정
	$signdate = time();
	$tm_sign_id = $cf_cook_id ? $cf_cook_id : "";
	$tm_sign_nm = $fr_input_nm;
	$tm_sign_ip = $_SERVER[REMOTE_ADDR];


	if($fr_input_Y)
	{
		$tm_input_ymdhms =	sprintf("%04d", $fr_input_Y) .
							sprintf("%02d", $fr_input_m) .
							sprintf("%02d", $fr_input_d) . "000000";
	//						sprintf("%02d", $fr_input_H) .
	//						sprintf("%02d", $fr_input_i) .
	//						sprintf("%02d", $fr_input_s);
	}

	# 강제 입력날자 입력시 입력날자도 업데이트한다.
	if($tm_input_ymdhms)
		$upd_query_time = "input_ymdhms	= '$tm_input_ymdhms', ";
	else
		$upd_query_time = "";

	# -------------------------------------------------------------- #
	#	Update Query
	# -------------------------------------------------------------- #
	// 현재과 같은 부모글을 가지고 답변정렬이 큰놈들중 가장 작은 정렬번호를 찾는다.
	$query = "SELECT MIN(SORT) FROM $cf_table_col_nm WHERE FID = $my_fid AND SORT > $my_sort AND DEPTH <= $my_depth";
	$my_next_sort = $DB->Value($query);

	if($my_next_sort != 0 && is_numeric($my_next_sort))
	{
		// SERVICE_YN은 자기보다 하위게시물들을 같이 변경해준다.
		$query = "UPDATE $cf_table_col_nm SET " .
						"SERVICE_YN = '$tm_service_yn' " .
					"WHERE FID = $my_fid AND SORT > $my_sort AND SORT < $my_next_sort";
	}
	else
	{
		$query = "UPDATE $cf_table_col_nm SET " .
						"SERVICE_YN = '$tm_service_yn' " .
					"WHERE FID = $my_fid AND SORT > $my_sort";
	}

	$DB->Update_Query($query);

	# 비밀글 여부
	if($cf_secret_yn == "Y") {
		if(!$fr_secret_yn || $fr_secret_yn == "N") {
			$tm_secret_yn = "N";
		} else {
			$tm_secret_yn = "Y";
		}
	} else {
		$tm_secret_yn = "N";
	}

	// 자신이 게시물에서만 변경하는 것들 변경
	$query = "UPDATE " . $cf_table_col_nm . " SET " .
					"CATEGORY = '$fr_category', " .
					"EMAIL = '$fr_email', " .
					"HOMEPAGE = '$fr_homepage', " .
					"SUBJECT = '$fr_subject', " .
					"MEMO = '$fr_memo', " .
					"MEMO2 = '$fr_memo2', " .
					"HTML_YN = '$tm_html_yn', " .
					"PUBLIC_YN = '$tm_public_yn', " .
					"SERVICE_YN	= '$tm_service_yn', " .
					"NOTICE_YN = '$tm_notice_yn', " .
					"SECRET_YN = '$tm_secret_yn'," .
					$upd_query_time .
					"SIGN_ID = '$tm_sign_id', " .
					"SIGN_NM = '$tm_sign_nm', " .
					"SIGN_IP = '$tm_sign_ip', " .
					"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
				"WHERE NO = '$po_no'";
	$DB->Update_Query($query);
	

	include "upload_modify.inc";

	//통계테이블

	error_msg("내용이 수정되었습니다.", "iframe_listbody.html?$po_adv_query&page=$page&po_no=$po_no");

	# DB 접속종료
	include "logoff.inc";
?>
