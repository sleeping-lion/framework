<?
include $_SERVER[DOCUMENT_ROOT]."/Root_Path.inc";
include "variable_config.inc";
include "user_function.inc";
include  "logon.inc";
include "t_config.inc";

/*
echo "POST<br>";
foreach($_POST as $k => $v){
	echo $k."=>".$v."<br>";
}
echo "<br>";
echo "fr_receipt_cd : ".$fr_receipt_cd;
echo "<br>";
exit;
*/


// 무통장의 경우 입금확인일경우
if($fr_receipt_cd == "20") { // 입금확인

	# ----------------------------------------------------------------- #
	# 전체처리작업정리
	#
	#	1. 장바구니 테이블
	#		- cheri_cd : 50
	#	2. 주문 테이블
	#		- progress : 50
	#		- credit_no : 해당결제번호
	#	3. 결제 테이블
	#		- auto_no : Ymd + 결제테이블SEQ
	#		- auto_date : 현재Ymd
	#		- response_code : 결과코드(0000)
	#		- receipt_cd : 20 (입금확인)
	#		- re_amount : 입금액
	#	4. 회원 테이블
	#		- cm_point : 마일리지지급
	#	5. 기타 수정정보
	#		- sign_ymdhms : 최종수정일
	#		- writer : 최종수정자ID
	# ----------------------------------------------------------------- #

	$signdate			= time();
	$tm_input_id		= $cf_cook_id;
	$tm_input_nm		= $cf_cook_nm;
	$tm_input_ip		= $_SERVER[REMOTE_ADDR];
	$tm_input_ymdhms	= date("YmdHis",$signdate);
	$tm_sign_id			= $tm_input_id;
	$tm_sign_nm			= $tm_input_nm;
	$tm_sign_ip			= $tm_input_ip;
	$tm_sign_ymdhms		= $tm_input_ymdhms;
	$tm_writer = $cf_cook_id;

	// 수정을 위해서 결제테이블에서 정보를 가져온다.
	$query = "SELECT SEQ, CREDIT_NO, AMOUNT, MILEAGE_POINT, INPUT_ID FROM $cf_table_cre_nm WHERE ORDER_NO = '$po_no'";
	$credit_arr = $DB->Pipe_Row($query);

	// 입금확인코드
	# 참고로 fr_receipt_cd 값이 20일때 조건문에 들어온다.
	$tm_receipt_cd = "20";

	// 결제금액
	$tm_re_amount = $credit_arr[AMOUNT];//구매액이 실제 결제금액이 된다.

	// 승인번호 Ymd + 결제테이블의 SEQ
	$tm_auth_no = substr($tm_sign_ymdhms, 0, 8) . $credit_arr[SEQ];
	
	// 승일날자
	$tm_auth_date = $tm_sign_ymdhms;

	// 결과코드 (성공시 : 0000) ==> 정상처리 나타냄
	$tm_response_code = "00";

	$query_cart_up = "UPDATE $cf_table_car_nm SET " .
							"CHERI_CD = '50', " .
							"WRITER = '$tm_writer', " .
							"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
						"WHERE ORDER_NO = '$po_no'";

	// 주문테이블 업데이트 쿼리
	$query_order_up = "UPDATE $cf_table_ord_nm SET " . 
								"PROGRESS = '50', " .
								"CREDIT_NO = '" . $credit_arr[CREDIT_NO] . "', " .
								"WRITER = '$tm_writer', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";

	// 결제테이블 업데이트 쿼리
	$query_credit_up = "UPDATE $cf_table_cre_nm SET " .
								"RECEIPT_CD = '$tm_receipt_cd', " .
								"RE_AMOUNT = '$tm_re_amount', " .
								"AUTH_NO = '$tm_auth_no', " .
								"AUTH_DATE = '$tm_sign_ymdhms', " .
								"RESPONSE_CODE = '$tm_response_code', " .
								"WRITER = '$tm_writer', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";
/*
echo $query_cart_up."<br><br>";
echo $query_order_up."<br><br>";
echo $query_credit_up."<br><br>";
*/



	# ----------------------------------------------------------------- #
	#	업데이트 처리
	# ----------------------------------------------------------------- #
	$DB->Update_Query($query_cart_up);
	$DB->Update_Query($query_order_up);
	$DB->Update_Query($query_credit_up);


}



# 주문관리에서 수정하면 fr_progress 값이 없이 넘어오넹 ㅡㅡ;;
# -------------------------------
# 최초 수정시 fr_progress 값은 안넘어 온다. 결제상황을 입금확인으로 할 시에..
# 상태정보에서 배송신청을 하면 fr_progress 값이 넘어온다...
# -------------------------------
//echo "fr_progress : ".$fr_progress."<br>";


if($fr_progress) {	// 상태코드변경
  
 

	$signdate			= time();
	$tm_input_id		= $cf_cook_id;
	$tm_input_nm		= $cf_cook_nm;
	$tm_input_ip		= $_SERVER[REMOTE_ADDR];
	$tm_input_ymdhms	= date("YmdHis",$signdate);
	$tm_sign_id			= $tm_input_id;
	$tm_sign_nm			= $tm_input_nm;
	$tm_sign_ip			= $tm_input_ip;
	$tm_sign_ymdhms		= $tm_input_ymdhms;
	$tm_writer = $cf_cook_id;

  
  #마일리지 업데이트(이전값이 10이면 적립금추가, 이전값이 10아니고 한불일때는 적립금 제거)
  $fr_no = $po_no;
  include "html/mileage.inc";



	$query_cart_up = "UPDATE $cf_table_car_nm SET " .
							"CHERI_CD = '$fr_progress', " .
							"WRITER = '$tm_writer', " .
							"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
						"WHERE ORDER_NO = '$po_no'";

	// 주문테이블 업데이트 쿼리
	$query_order_up = "UPDATE $cf_table_ord_nm SET " . 
								"PROGRESS = '$fr_progress', " .
								"CREDIT_NO = '" . $credit_arr[CREDIT_NO] . "', " .
								"WRITER = '$tm_writer', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";

	// 결제테이블 업데이트 쿼리
	$query_credit_up = "UPDATE $cf_table_cre_nm SET " .
								//"RECEIPT_CD = '$tm_receipt_cd', " .
								//"RE_AMOUNT = '$tm_re_amount', " .
								//"AUTH_NO = '$tm_auth_no', " .
								//"AUTH_DATE = '$tm_sign_ymdhms', " .
								//"RESPONSE_CODE = '$tm_response_code', " .
								"WRITER = '$tm_writer', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";
/*
echo $query_cart_up."<br><br>";
echo $query_order_up."<br><br>";
echo $query_credit_up."<br><br>";
*/

	# ----------------------------------------------------------------- #
	#	업데이트 처리
	# ----------------------------------------------------------------- #
	$DB->Update_Query($query_cart_up);
	$DB->Update_Query($query_order_up);
	$DB->Update_Query($query_credit_up);

}

#############################3
// 택배사
if(is_array($fr_tak_no)) {

	foreach($fr_tak_no as $key=>$val) {
    ## 택배번호 ##
    $fr_tak_no = $fr_tak_no.$val;

		$fr_tak_name = ${"fr_tak_name_".$key};
		$query = "update MT_CART_T set TAK_NAME='$fr_tak_name',TAK_NO='$val' where SEQ='$key'";
		$DB->Update_Query($query);
		$query = "update MT_ORDER_T set TAK_NAME='$fr_tak_name',TAK_NO='$val' where SEQ='$key'";
		$DB->Update_Query($query);
	}
}




# 배송중/송장번호 있으면 메일발송 #
if($fr_progress == "60" && $fr_tak_name){
    $query_mail1 = "SELECT AUTH_NO, AUTH_DATE, A.INPUT_YMDHMS, RE_AMOUNT, SEN_NAME, SEN_EMAIL  FROM MT_CREDIT_T A, MT_ORDER_T B WHERE A.ORDER_NO = '$po_no' and A.ORDER_NO=B.ORDER_NO limit 0,1";
   	$arr1 = $DB->Pipe_Row($query_mail1);
    
    $fr_order_no = $po_no;                    #주문번호
    $fr_progress = $fr_progress;              #배송상태
    $fr_tak_name = $fr_tak_name;              #택배사

    $fr_auth_no = $arr1[AUTH_NO];             #승인번호
    $fr_auth_date = $arr1[AUTH_DATE];         #승인일
    $fr_input_ymdhms = substr($arr1[INPUT_YMDHMS],0,4)."/".substr($arr1[INPUT_YMDHMS],4,2)."/".substr($arr1[INPUT_YMDHMS],6,2);   #일력일
    $fr_re_amount = $arr1[RE_AMOUNT];         #승인금액
    $fr_sen_name = $arr1[SEN_NAME];           #이름
    $fr_sen_email = $arr1[SEN_EMAIL];         #E-mail
    


    # CART_번호, 승인번호, 승일날짜, 주문일자, 총액, 구매자, 
    $query_mail2 = "SELECT a.IT_NAME, a.TAK_NO, b.NM as TAK_NAME from MT_CART_T a LEFT JOIN $cf_table_cod_nm b ON b.CD = a.TAK_NAME where ORDER_NO='$po_no'";
    $arr2 = $DB->Pipe_Arr($query_mail2);
    $fr_count = count($arr2);                 #상품갯수

    $fr_it_name = "";                         #주문상품
    for($i=0;$i<count($arr2);$i++){
      ## 주문상품
      $fr_it_name = $fr_it_name."<BR>".$arr2[$i][IT_NAME]."(택배사 : ".$arr2[$i][TAK_NAME].", 송장번호 :[<b><a href='http://www.kgbls.co.kr/tracing.asp?number=".$arr2[$i][TAK_NO]."' target='_blank'><font color='red'>".$arr2[$i][TAK_NO]."</font></a></b>])";

    }

    $m_to	= $fr_sen_email;
		$m_subject = "[ $cf_site_nm ] " . $fr_sen_name . "님의 상품이 배송되었습니다.";

    include "../../mail/basong_mail.inc";

		$add_header = "From:$cf_mail_from\n";			//받는사람
		$add_header .= "Reply-To:$cf_mail_from\n";	
		$add_header .= "Content-Type:text/html;charset=EUC-KR\n\n";

		mail($m_to,$m_subject,$contents_order,$add_header);


}

error_msg("","listbody.html?".$po_adv_query."&po_no=".$po_no."&page=".$page);

include  "logoff.inc";
?>