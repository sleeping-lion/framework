<?
include $_SERVER[DOCUMENT_ROOT]."/Root_Path.inc";
include "variable_config.inc";
include "user_function.inc";
include  "logon.inc";
include "t_config.inc";

/*
echo "POST<br>";
foreach($_POST as $k => $v){
	echo $k."=>".$v."<br>";
}
echo "<br>";
echo "fr_receipt_cd : ".$fr_receipt_cd;
echo "<br>";
exit;
*/


// 무통장의 경우 입금확인일경우
if($fr_receipt_cd == "20") { // 입금확인

	# ----------------------------------------------------------------- #
	# 전체처리작업정리
	#
	#	1. 장바구니 테이블
	#		- cheri_cd : 50
	#	2. 주문 테이블
	#		- progress : 50
	#		- credit_no : 해당결제번호
	#	3. 결제 테이블
	#		- auto_no : Ymd + 결제테이블SEQ
	#		- auto_date : 현재Ymd
	#		- response_code : 결과코드(0000)
	#		- receipt_cd : 20 (입금확인)
	#		- re_amount : 입금액
	#	4. 회원 테이블
	#		- cm_point : 마일리지지급
	#	5. 기타 수정정보
	#		- sign_ymdhms : 최종수정일
	#		- writer : 최종수정자ID
	# ----------------------------------------------------------------- #

	$signdate			= time();
	$tm_input_id		= $cf_cook_id;
	$tm_input_nm		= $cf_cook_nm;
	$tm_input_ip		= $_SERVER[REMOTE_ADDR];
	$tm_input_ymdhms	= date("YmdHis",$signdate);
	$tm_sign_id			= $tm_input_id;
	$tm_sign_nm			= $tm_input_nm;
	$tm_sign_ip			= $tm_input_ip;
	$tm_sign_ymdhms		= $tm_input_ymdhms;
	$tm_writer = $cf_cook_id;

	// 수정을 위해서 결제테이블에서 정보를 가져온다.
	$query = "SELECT SEQ, CREDIT_NO, AMOUNT, MILEAGE_POINT, INPUT_ID FROM $cf_table_cre_nm WHERE ORDER_NO = '$po_no'";
	$credit_arr = $DB->Pipe_Row($query);

	// 입금확인코드
	# 참고로 fr_receipt_cd 값이 20일때 조건문에 들어온다.
	$tm_receipt_cd = "20";

	// 결제금액
	$tm_re_amount = $credit_arr[AMOUNT];//구매액이 실제 결제금액이 된다.

	// 승인번호 Ymd + 결제테이블의 SEQ
	$tm_auth_no = substr($tm_sign_ymdhms, 0, 8) . $credit_arr[SEQ];
	
	// 승일날자
	$tm_auth_date = $tm_sign_ymdhms;

	// 결과코드 (성공시 : 0000) ==> 정상처리 나타냄
	$tm_response_code = "00";

	$query_cart_up = "UPDATE $cf_table_car_nm SET " .
							"CHERI_CD = '50', " .
							"WRITER = '$tm_writer', " .
							"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
						"WHERE ORDER_NO = '$po_no'";

	// 주문테이블 업데이트 쿼리
	$query_order_up = "UPDATE $cf_table_ord_nm SET " . 
								"PROGRESS = '50', " .
								"CREDIT_NO = '" . $credit_arr[CREDIT_NO] . "', " .
								"WRITER = '$tm_writer', " .
								"APP_NO = '$fr_app_no', " .
								"APPLY_PAPER = '$fr_apply_paper', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";

	// 결제테이블 업데이트 쿼리
	$query_credit_up = "UPDATE $cf_table_cre_nm SET " .
								"RECEIPT_CD = '$tm_receipt_cd', " .
								"RE_AMOUNT = '$tm_re_amount', " .
								"AUTH_NO = '$tm_auth_no', " .
								"AUTH_DATE = '$tm_sign_ymdhms', " .
								"RESPONSE_CODE = '$tm_response_code', " .
								"WRITER = '$tm_writer', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";
/*
echo $query_cart_up."<br><br>";
echo $query_order_up."<br><br>";
echo $query_credit_up."<br><br>";
*/



	# ----------------------------------------------------------------- #
	#	업데이트 처리
	# ----------------------------------------------------------------- #
	$DB->Update_Query($query_cart_up);
	$DB->Update_Query($query_order_up);
	$DB->Update_Query($query_credit_up);


}



# 주문관리에서 수정하면 fr_progress 값이 없이 넘어오넹 ㅡㅡ;;
# -------------------------------
# 최초 수정시 fr_progress 값은 안넘어 온다. 결제상황을 입금확인으로 할 시에..
# 상태정보에서 배송신청을 하면 fr_progress 값이 넘어온다...
# -------------------------------
//echo "fr_progress : ".$fr_progress."<br>";


if($fr_progress) {	// 상태코드변경
  
 

	$signdate			= time();
	$tm_input_id		= $cf_cook_id;
	$tm_input_nm		= $cf_cook_nm;
	$tm_input_ip		= $_SERVER[REMOTE_ADDR];
	$tm_input_ymdhms	= date("YmdHis",$signdate);
	$tm_sign_id			= $tm_input_id;
	$tm_sign_nm			= $tm_input_nm;
	$tm_sign_ip			= $tm_input_ip;
	$tm_sign_ymdhms		= $tm_input_ymdhms;
	$tm_writer = $cf_cook_id;

  
  #마일리지 업데이트(이전값이 10이면 적립금추가, 이전값이 10아니고 한불일때는 적립금 제거)
  $fr_no = $po_no;
  include "html/mileage.inc";



	$query_cart_up = "UPDATE $cf_table_car_nm SET " .
							"CHERI_CD = '$fr_progress', " .
							"WRITER = '$tm_writer', " .
							"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
						"WHERE ORDER_NO = '$po_no'";

	// 주문테이블 업데이트 쿼리
	$query_order_up = "UPDATE $cf_table_ord_nm SET " . 
								"PROGRESS = '$fr_progress', " .
								"CREDIT_NO = '" . $credit_arr[CREDIT_NO] . "', " .
								"WRITER = '$tm_writer', " .
								"APP_NO = '$fr_app_no', " .
								"APPLY_PAPER = '$fr_apply_paper', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";

	// 결제테이블 업데이트 쿼리
	$query_credit_up = "UPDATE $cf_table_cre_nm SET " .
								//"RECEIPT_CD = '$tm_receipt_cd', " .
								//"RE_AMOUNT = '$tm_re_amount', " .
								//"AUTH_NO = '$tm_auth_no', " .
								//"AUTH_DATE = '$tm_sign_ymdhms', " .
								//"RESPONSE_CODE = '$tm_response_code', " .
								"WRITER = '$tm_writer', " .
								"SIGN_YMDHMS = '$tm_sign_ymdhms' " .
							"WHERE ORDER_NO = '$po_no'";



	
/*
echo $query_cart_up."<br><br>";
echo $query_order_up."<br><br>";
echo $query_credit_up."<br><br>";
*/

	# ----------------------------------------------------------------- #
	#	업데이트 처리
	# ----------------------------------------------------------------- #
	$DB->Update_Query($query_cart_up);
	$DB->Update_Query($query_order_up);
	$DB->Update_Query($query_credit_up);

}

#############################3
// 택배사
if(is_array($fr_tak_no)) {

	foreach($fr_tak_no as $key=>$val) {
    ## 택배번호 ##
    $fr_tak_no = $fr_tak_no.$val;

		$fr_tak_name = ${"fr_tak_name_".$key};
		$query = "update MT_CART_T set TAK_NAME='$fr_tak_name',TAK_NO='$val' where SEQ='$key'";
		$DB->Update_Query($query);
		$query = "update MT_ORDER_T set TAK_NAME='$fr_tak_name',TAK_NO='$val' where SEQ='$key'";
		$DB->Update_Query($query);
	}
}


$query_sms_chk = "select MSG1,MSG2,MSG3,MSG4,MSG5,MSG6,MSG7,MSG8,MSG9,MSG10 from CM_SMS_C ";
$row_sms_chk = mysql_fetch_array(mysql_query($query_sms_chk));
$my_msg1 = $row_sms_chk[MSG1];
$my_msg2 = $row_sms_chk[MSG2];
$my_msg3 = $row_sms_chk[MSG3];
$my_msg4 = $row_sms_chk[MSG4];
$my_msg5 = $row_sms_chk[MSG5];
$my_msg6 = $row_sms_chk[MSG6];
$my_msg7 = $row_sms_chk[MSG7];
$my_msg8 = $row_sms_chk[MSG8];
$my_msg9 = $row_sms_chk[MSG9];
$my_msg10 = $row_sms_chk[MSG10];

$my_msg_v = 0;
if( ($fr_progress=="01" && $my_msg1 != "")||($fr_progress=="02" && $my_msg2 != "")||($fr_progress=="03" && $my_msg3 != "")||($fr_progress=="04" && $my_msg4 != "")||($fr_progress=="05" && $my_msg5 != "")||($fr_progress=="06" && $my_msg6 != "")||($fr_progress=="07" && $my_msg7 != "")||($fr_progress=="08" && $my_msg8 != "")||($fr_progress=="09" && $my_msg9 != "")||($fr_progress=="10" && $my_msg10 != "") ){
	$my_msg_v = "Y";
}

if( $fr_progress != $old_progress && $my_msg_v == "Y" ) {
	$sms_ok = "Y";
}else{
	$sms_ok = "N";
}


if( $fr_progress != $old_progress && $sms_ok=="Y" ){ //이전 상태코드와 넘어온 상태코드가 다르고 sms_ok=Y일경우...

	
	//결제금액
	$query3 = "select AMOUNT from MT_CREDIT_T where ORDER_NO = '$po_no' limit 0,1 ";
	$row3 = mysql_fetch_array(mysql_query($query3));

	//상품명
	$query2 = "select IT_NAME,TAK_NO from MT_CART_T where ORDER_NO = '$po_no' limit 0,1 ";
	$row2 = mysql_fetch_array(mysql_query($query2));

	//주문자 id,이름,휴대폰번호
	$query = "select INPUT_ID,SEN_NAME,SEN_HP_TEL from MT_ORDER_T where ORDER_NO = '$po_no' ";
	$row = mysql_fetch_array(mysql_query($query));

	if($fr_progress=="01" && $my_msg1 != ""){
		$msg = $my_msg1."/".number_format($row3[AMOUNT])."원/주문no:".$po_no;
		$msg_title = "주문접수";
	}elseif($fr_progress=="02" && $my_msg2 != ""){
		$msg = $my_msg2."/".number_format($row3[AMOUNT])."원/주문no:".$po_no;
		$msg_title = "입금확인";
	}elseif($fr_progress=="03" && $my_msg3 != ""){
		$msg = $my_msg3."/".number_format($row3[AMOUNT])."원/주문no:".$po_no;
		$msg_title = "배송준비";
	}elseif($fr_progress=="04" && $my_msg4 != ""){
		$msg = $my_msg4."/".$row2[IT_NAME]."/운송장:".$row2[TAK_NO];
		$msg_title = "상품발송";
	}elseif($fr_progress=="05" && $my_msg5 != ""){
		$msg = $my_msg5."/".$row2[IT_NAME]."/운송장:".$row2[TAK_NO];
		$msg_title = "거래완료";
	}elseif($fr_progress=="06" && $my_msg6 != ""){
		$msg = $my_msg6."/".$row2[IT_NAME]."/".number_format($row3[AMOUNT])."원";
		$msg_title = "주문취소";
	}elseif($fr_progress=="07" && $my_msg7 != ""){
		$msg = $my_msg7."/".$row2[IT_NAME]."/".number_format($row3[AMOUNT])."원";
		$msg_title = "환불요청";
	}elseif($fr_progress=="08" && $my_msg8 != ""){
		$msg = $my_msg8."/".$row2[IT_NAME]."/".number_format($row3[AMOUNT])."원";
		$msg_title = "환불완료";
	}elseif($fr_progress=="09" && $my_msg9 != ""){
		$msg = $my_msg9."/".$row2[IT_NAME]."/".number_format($row3[AMOUNT])."원";
		$msg_title = "교환요청";
	}elseif($fr_progress=="10" && $my_msg10 != ""){
		$msg = $my_msg10."/".$row2[IT_NAME]."/".number_format($row3[AMOUNT])."원";
		$msg_title = "교환완료";
	}

   /******************** 인증정보 ********************/
	$sms_url = "http://sslsms.cafe24.com/sms_sender.php"; // 전송요청 URL
	// $sms_url = "https://sslsms.cafe24.com/sms_sender.php"; // HTTPS 전송요청 URL
	$sms['user_id'] = base64_encode("peachtech"); //SMS 아이디.
	$sms['secure'] = base64_encode("85e5d2a7deff46b59446bc21b3d8636d") ;//인증키
	$sms['msg'] = base64_encode(stripslashes($msg));

	$sms['rphone'] = base64_encode($row[SEN_HP_TEL]);
	$sms['sphone1'] = base64_encode("02");
	$sms['sphone2'] = base64_encode("859");
	$sms['sphone3'] = base64_encode("3477");
	$sms['rdate'] = base64_encode($_POST['rdate']);
	$sms['rtime'] = base64_encode($_POST['rtime']);
	$sms['mode'] = base64_encode("1"); // base64 사용시 반드시 모드값을 1로 주셔야 합니다.
	$sms['returnurl'] = base64_encode("http://".$_SERVER['SERVER_NAME']."/manager/order/listbody.html?a_gb=order&a_cd=1&a_item=0&po_no=".$po_no."&page=".$page);
	$sms['testflag'] = base64_encode('N');
	$sms['destination'] = base64_encode($_POST['destination']);
	$returnurl = "http://".$_SERVER['SERVER_NAME']."/manager/order/listbody.html?a_gb=order&a_cd=1&a_item=0&po_no=".$po_no."&page=".$page;
	$sms['repeatFlag'] = base64_encode($_POST['repeatFlag']);
	$sms['repeatNum'] = base64_encode($_POST['repeatNum']);
	$sms['repeatTime'] = base64_encode($_POST['repeatTime']);
	//$nointeractive = $_POST['nointeractive']; //사용할 경우 : 1, 성공시 대화상자(alert)를 생략
	$nointeractive = 1;

	$host_info = explode("/", $sms_url);
	$host = $host_info[2];
	$path = $host_info[3];

	srand((double)microtime()*1000000);
	$boundary = "---------------------".substr(md5(rand(0,32000)),0,10);
	//print_r($sms);

	// 헤더 생성
	$header = "POST /".$path ." HTTP/1.0\r\n";
	$header .= "Host: ".$host."\r\n";
	$header .= "Content-type: multipart/form-data, boundary=".$boundary."\r\n";

	// 본문 생성
	foreach($sms AS $index => $value){
		$data .="--$boundary\r\n";
		$data .= "Content-Disposition: form-data; name=\"".$index."\"\r\n";
		$data .= "\r\n".$value."\r\n";
		$data .="--$boundary\r\n";
	}
	$header .= "Content-length: " . strlen($data) . "\r\n\r\n";

	$fp = fsockopen($host, 80);

	if ($fp) {
		fputs($fp, $header.$data);
		$rsp = '';
		while(!feof($fp)) {
			$rsp .= fgets($fp,8192);
		}
		fclose($fp);
		$msg = explode("\r\n\r\n",trim($rsp));
		$rMsg = explode(",", $msg[1]);
		$Result= $rMsg[0]; //발송결과
		$Count= $rMsg[1]; //잔여건수

		//발송결과 알림
		if($Result=="success") {

			$query =    "insert into CM_SMS_T (" .
					"S_ID, " .
					"S_IP, " .
					"S_PHONE, " .
					"R_PHONE, " .
					"R_NAME, " .
					"R_ID, " .
					"R_MSG, " .
					"ORDER_NO, " .
					"STATUS, " .
					"INPUT_YMDHMS" .

				") values (".
					"'admin', " .
					"'$tm_input_ip',".
					"'02-859-3477',".
					"'$row[SEN_HP_TEL]',".
					"'$row[SEN_NAME]',".
					"'$row[INPUT_ID]',".
					"'$msg_title',".
					"'$po_no',".
					"'2',".				
					"'$tm_input_ymdhms'" .
				")";

			if($DB->Insert_Query($query)){						
			}

			$alert = "성공";
			$alert .= " 잔여건수는 ".$Count."건 입니다.";
		}
		else if($Result=="reserved") {
			$alert = "성공적으로 예약되었습니다.";
			$alert .= " 잔여건수는 ".$Count."건 입니다.";
		}
		else if($Result=="3205") {
			$alert = "잘못된 번호형식입니다.";
		}

		else if($Result=="0044") {
			$alert = "스팸문자는발송되지 않습니다.";
		}

		else {
			$query =    "insert into CM_SMS_T (" .
					"S_ID, " .
					"S_IP, " .
					"S_PHONE, " .
					"R_PHONE, " .
					"R_NAME, " .
					"R_ID, " .
					"R_MSG, " .
					"ORDER_NO, " .
					"STATUS, " .
					"INPUT_YMDHMS" .

				") values (".
					"'admin', " .
					"'$tm_input_ip',".
					"'02-859-3477',".
					"'$row[SEN_HP_TEL]',".
					"'$row[SEN_NAME]',".
					"'$row[INPUT_ID]',".
					"'$msg_title',".
					"'$po_no',".
					"'1',".				
					"'$tm_input_ymdhms'" .
				")";

			if($DB->Insert_Query($query)){						
			}
			$alert = "[Error]".$Result;
		}
	}
	else {
		$alert = "Connection Failed";
	}
}


# 배송중/송장번호 있으면 메일발송 #
if($fr_progress == "60" && $fr_tak_name){
    $query_mail1 = "SELECT AUTH_NO, AUTH_DATE, A.INPUT_YMDHMS, RE_AMOUNT, SEN_NAME, SEN_EMAIL  FROM MT_CREDIT_T A, MT_ORDER_T B WHERE A.ORDER_NO = '$po_no' and A.ORDER_NO=B.ORDER_NO limit 0,1";
   	$arr1 = $DB->Pipe_Row($query_mail1);
    
    $fr_order_no = $po_no;                    #주문번호
    $fr_progress = $fr_progress;              #배송상태
    $fr_tak_name = $fr_tak_name;              #택배사

    $fr_auth_no = $arr1[AUTH_NO];             #승인번호
    $fr_auth_date = $arr1[AUTH_DATE];         #승인일
    $fr_input_ymdhms = substr($arr1[INPUT_YMDHMS],0,4)."/".substr($arr1[INPUT_YMDHMS],4,2)."/".substr($arr1[INPUT_YMDHMS],6,2);   #일력일
    $fr_re_amount = $arr1[RE_AMOUNT];         #승인금액
    $fr_sen_name = $arr1[SEN_NAME];           #이름
    $fr_sen_email = $arr1[SEN_EMAIL];         #E-mail
    


    # CART_번호, 승인번호, 승일날짜, 주문일자, 총액, 구매자, 
    $query_mail2 = "SELECT a.IT_NAME, a.TAK_NO, b.NM as TAK_NAME from MT_CART_T a LEFT JOIN $cf_table_cod_nm b ON b.CD = a.TAK_NAME where ORDER_NO='$po_no'";
    $arr2 = $DB->Pipe_Arr($query_mail2);
    $fr_count = count($arr2);                 #상품갯수

    $fr_it_name = "";                         #주문상품
    for($i=0;$i<count($arr2);$i++){
      ## 주문상품
      $fr_it_name = $fr_it_name."<BR>".$arr2[$i][IT_NAME]."(택배사 : ".$arr2[$i][TAK_NAME].", 송장번호 :[<b><a href='http://www.kgbls.co.kr/tracing.asp?number=".$arr2[$i][TAK_NO]."' target='_blank'><font color='red'>".$arr2[$i][TAK_NO]."</font></a></b>])";

    }

    $m_to	= $fr_sen_email;
		$m_subject = "[ $cf_site_nm ] " . $fr_sen_name . "님의 상품이 배송되었습니다.";

    include "../../mail/basong_mail.inc";

		$add_header = "From:$cf_mail_from\n";			//받는사람
		$add_header .= "Reply-To:$cf_mail_from\n";	
		$add_header .= "Content-Type:text/html;charset=EUC-KR\n\n";

		mail($m_to,$m_subject,$contents_order,$add_header);


}

error_msg("","listbody.html?".$po_adv_query."&po_no=".$po_no."&page=".$page);

include  "logoff.inc";
?>