<?
	# 패스 및 클래스
	include $_SERVER[DOCUMENT_ROOT]."/Root_Path.inc";
	include "variable_config.inc";

	# DB 접속 및 함수
	include "logon.inc";
	include "user_function.inc";

	#년도 월 일 그룹
	
	$po_st_year		= $_POST["po_st_year"];
	$po_st_month	= $_POST["po_st_month"];
	$fr_it_no		= $_POST["fr_it_no"];
	$fr_op_name		= $_POST["fr_op_name"];
	$fr_progress	= $_POST["fr_progress"];

	if($po_st_month < 10){
		$po_st_month = "0".$po_st_month;
	}

	$search_con1	= "";
	$search_con2	= "";

	if($fr_it_no !=""){
		$search_con1 .= " AND B.IT_NO = '$fr_it_no'";
	}

	if($fr_op_name !=""){
		$search_con1 .= " AND B.OP_NAME = '$fr_op_name'";
	}

	if($fr_progress !="" && $fr_progress !="03"){
		$search_con1 .= " AND A.PROGRESS = '$fr_progress'";
	}

	if($fr_progress !="" && $fr_progress =="03"){
		$search_con1 .= " AND (A.PROGRESS = '03' or A.PROGRESS = '04' or A.PROGRESS = '05' ) ";
	}


	if($po_st_year != ""){
		$po_st_year = $po_st_year;
	}else{
		$po_st_year = date("Y");
	}

	if($po_st_month != ""){
		$po_st_month = $po_st_month;
	}else{
		$po_st_month = date("m");
	}

	$search_con2 .= " AND R.INPUT_YMD LIKE  '$po_st_year$po_st_month%'";

	$json = "{\"item\":[";

	$query ="	SELECT 
					R.INPUT_YMD
					,R.INPUT_YM 
					,R.QAT R_QAT
					,R.CART_TOT R_CART_TOT
					,R1.QAT R1_QAT
					,R1.CART_TOT R1_CART_TOT		
					,R2.QAT R2_QAT
					,R2.CART_TOT R2_CART_TOT
					,R3.QAT R3_QAT
					,R3.CART_TOT R3_CART_TOT
				FROM 
				(
					SELECT 	
						INPUT_YMD
						,SUM(T1.QAT) QAT
						,SUM(T1.CART_TOT) CART_TOT
						,MAX(INPUT_YM) INPUT_YM
					FROM (
						SELECT 
							B.ORDER_NO					-- 주문번호
							,B.OP_NAME					-- 옵션명
							,B.IT_NO					-- 상품 코드
							,B.QAT						-- 수량		
							,B.IT_SALE_PRICE				-- 할인금액	
							,(B.QAT * B.IT_SALE_PRICE) CART_TOT		-- 카트별 총금액
							,A.PROGRESS					-- 주문상태
							,A.INPUT_YMDHMS					-- 주문일자
							,SUBSTRING(A.INPUT_YMDHMS,1,8) INPUT_YMD	-- 주문일자(일까지)
							,SUBSTRING(A.INPUT_YMDHMS,1,6) INPUT_YM		-- 주문일자(월까지)
							,C.SETTLEMENT_CD				-- 결제 방법			
						FROM MT_ORDER_T A
						LEFT JOIN MT_CART_T B
						ON A.ORDER_NO = B.ORDER_NO
						INNER JOIN  MT_CREDIT_T C
						ON A.ORDER_NO = C.ORDER_NO 
						WHERE 1=1
						AND B.ORDER_NO != ''
					)T1 
					GROUP BY INPUT_YMD 
				) R 
				LEFT JOIN(
					SELECT 	
						INPUT_YMD
						,SUM(T1.QAT) QAT
						,SUM(T1.CART_TOT) CART_TOT
						,MAX(INPUT_YM) INPUT_YM
					FROM (
						SELECT 
							B.ORDER_NO					-- 주문번호
							,B.OP_NAME					-- 옵션명
							,B.IT_NO					-- 상품 코드
							,B.QAT						-- 수량		
							,B.IT_SALE_PRICE				-- 할인금액	
							,(B.QAT * B.IT_SALE_PRICE) CART_TOT		-- 카트별 총금액
							,A.PROGRESS					-- 주문상태
							,A.INPUT_YMDHMS					-- 주문일자
							,SUBSTRING(A.INPUT_YMDHMS,1,8) INPUT_YMD	-- 주문일자(일까지)
							,SUBSTRING(A.INPUT_YMDHMS,1,6) INPUT_YM		-- 주문일자(월까지)
							,C.SETTLEMENT_CD				-- 결제 방법			
						FROM MT_ORDER_T A
						LEFT JOIN MT_CART_T B
						ON A.ORDER_NO = B.ORDER_NO
						INNER JOIN  MT_CREDIT_T C
						ON A.ORDER_NO = C.ORDER_NO 
						WHERE 1=1
						AND B.ORDER_NO != ''
						AND C.SETTLEMENT_CD = '20'
						$search_con1		
					)T1 
					GROUP BY INPUT_YMD 
				) R1 
				ON R.INPUT_YMD = R1.INPUT_YMD
				LEFT JOIN (
					SELECT 	
						INPUT_YMD
						,SUM(T1.QAT) QAT
						,SUM(T1.CART_TOT) CART_TOT
						,MAX(INPUT_YM) INPUT_YM
					FROM (
						SELECT 
							B.ORDER_NO					-- 주문번호
							,B.OP_NAME					-- 옵션명
							,B.IT_NO					-- 상품 코드
							,B.QAT						-- 수량		
							,B.IT_SALE_PRICE				-- 할인금액	
							,(B.QAT * B.IT_SALE_PRICE) CART_TOT		-- 카트별 총금액
							,A.PROGRESS					-- 주문상태
							,A.INPUT_YMDHMS					-- 주문일자
							,SUBSTRING(A.INPUT_YMDHMS,1,8) INPUT_YMD	-- 주문일자(일까지)
							,SUBSTRING(A.INPUT_YMDHMS,1,6) INPUT_YM		-- 주문일자(월까지)
							,C.SETTLEMENT_CD				-- 결제 방법			
						FROM MT_ORDER_T A
						LEFT JOIN MT_CART_T B
						ON A.ORDER_NO = B.ORDER_NO
						INNER JOIN  MT_CREDIT_T C
						ON A.ORDER_NO = C.ORDER_NO 
						WHERE 1=1
						AND B.ORDER_NO != ''
						AND C.SETTLEMENT_CD = '10'
						$search_con1
						
					)T1 
					GROUP BY INPUT_YMD 
				) R2
				ON R.INPUT_YMD = R2.INPUT_YMD
				LEFT JOIN (
					SELECT 	
						INPUT_YMD
						,SUM(T1.QAT) QAT
						,SUM(T1.CART_TOT) CART_TOT
						,MAX(INPUT_YM) INPUT_YM
					FROM (
						SELECT 
							B.ORDER_NO					-- 주문번호
							,B.OP_NAME					-- 옵션명
							,B.IT_NO					-- 상품 코드
							,B.QAT						-- 수량		
							,B.IT_SALE_PRICE				-- 할인금액	
							,(B.QAT * B.IT_SALE_PRICE) CART_TOT		-- 카트별 총금액
							,A.PROGRESS					-- 주문상태
							,A.INPUT_YMDHMS					-- 주문일자
							,SUBSTRING(A.INPUT_YMDHMS,1,8) INPUT_YMD	-- 주문일자(일까지)
							,SUBSTRING(A.INPUT_YMDHMS,1,6) INPUT_YM		-- 주문일자(월까지)
							,C.SETTLEMENT_CD				-- 결제 방법			
						FROM MT_ORDER_T A
						LEFT JOIN MT_CART_T B
						ON A.ORDER_NO = B.ORDER_NO
						INNER JOIN  MT_CREDIT_T C
						ON A.ORDER_NO = C.ORDER_NO 
						WHERE 1=1
						AND B.ORDER_NO != ''
						AND C.SETTLEMENT_CD = '30'
						$search_con1
					)T1 
					GROUP BY INPUT_YMD 
				) R3 
				ON R.INPUT_YMD = R3.INPUT_YMD
				WHERE 1=1
				$search_con2
				ORDER BY R.INPUT_YMD ASC";
	
	$result = mysql_query($query);
	//echo "<pre>";
	//echo $query;
	
	$i = 0;
	while($row = mysql_fetch_array($result)){
		$INPUT_YMD			=	$row["INPUT_YMD"];
		$INPUT_YM			=	$row["INPUT_YM"];
		$R1_QAT				=	$row["R1_QAT"];
		$R1_CART_TOT		=	$row["R1_CART_TOT"];
		$R2_QAT				=	$row["R2_QAT"];
		//if($R2_QAT>1 && $po_st_month==2){
		//	$R2_QAT = $R2_QAT / 2;
		//}
		$R2_CART_TOT		=	$row["R2_CART_TOT"];
		$R3_QAT				=	$row["R3_QAT"];
		$R3_CART_TOT		=	$row["R3_CART_TOT"];
		
		if($i != 0) $json .= ",";
		$json	.= "{";
		$json	.= "\"INPUT\":\"$INPUT_YMD\"";
		$json	.= ",\"R1_QAT\":\"$R1_QAT\"";
		$json	.= ",\"R1_CART_TOT\":\"$R1_CART_TOT\"";
		$json	.= ",\"R2_QAT\":\"$R2_QAT\"";
		$json	.= ",\"R2_CART_TOT\":\"$R2_CART_TOT\"";
		$json	.= ",\"R3_QAT\":\"$R3_QAT\"";
		$json	.= ",\"R3_CART_TOT\":\"$R3_CART_TOT\"";
		$json	.= "}";
		$i++;

	}
	
	$json .= "]}";

	echo $json;

	# DB 접속종료
	include "logoff.inc";
?>
