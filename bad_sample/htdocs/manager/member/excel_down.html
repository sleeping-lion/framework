<?php
//echo "12121212";exit;
include $_SERVER[DOCUMENT_ROOT]."/Root_Path.inc";
include "variable_config.inc";

include  "logon.inc";
include  "user_function.inc";


	# 초기값 설정
	$board = new CPaging();
	$page = $page ? $page : 1;
	//$cf_num_per_page = $check_line ? $check_line : $cf_num_per_page;
	$cf_num_per_page = 1000000000;

	$day=date("Y-m-d");		
	$b_name = "member_list";

	Header("Content-type: application/vnd.ms-excel");
		Header("Content-type: charset=utf-8");
		header("Content-Disposition: attachment; filename=".$b_name."_".$day.".xls");
		Header("Content-Description: PHP4 Generated Data");
		Header("Pragma: no-cache");
		Header("Expires: 0");

	# ------------------------------------------------------------ #
	#	사용할 쿼리정리 시작
	# ----------------------------------------------------------- #
	$query_select = "SELECT CM_ID, CM_NM, CM_EMAIL, CM_HP_TEL, CM_LOG_CNT, CM_LEVEL, CM_DEL_YN,INPUT_YMDHMS, CM_ADDR, CM_ADDR2, CM_ZIP_CD ";
	$query_select_count = "SELECT COUNT(CM_ID) ";
	$query_from = "FROM $cf_table_mem_nm ";
	$query_where .= "WHERE CM_LEVEL >= '$cf_cook_level' ";
	$query_order = " ORDER BY INPUT_YMDHMS DESC ";

	if($sr_start_day && $sr_end_day) {	// 주문날짜
		$query_where .= "AND (DATE_FORMAT(INPUT_YMDHMS,'%Y%m%d') >= $sr_start_day AND DATE_FORMAT(INPUT_YMDHMS,'%Y%m%d') <= $sr_end_day) ";
	}

	if($level)
		$query_where .= "AND CM_LEVEL = '$level' ";

	// 검색키가 있는경우
	if(eregi("[^[:space:]]+",$key))
	{
		$encoded_key = urlencode($key);

		if ($keyfield_id || $keyfield_nm || $keyfield_tel)
		{
			$query_where = $query_where . "AND ( ";
			if($keyfield_id)
				$query_id = "$keyfield_id LIKE '%$key%' ";
			else
				$query_id = "1 = 2 ";

			if($keyfield_nm)
				$query_nm = "$keyfield_nm LIKE '%$key%' ";
			else
				$query_nm = "1 = 2 ";

			if($keyfield_tel)
				$query_tel = "$keyfield_tel LIKE '%$key%' ";
			else
				$query_tel = "1 = 2 ";

			$query_where	= 	$query_where .
								$query_id . "OR " .
								$query_nm . "OR " .
								$query_tel . ")";
		}
	}
	# ------------------------------------------------------------ #
	#	사용할 쿼리정리 끝
	# ----------------------------------------------------------- #
	
	##################################################

	# ---- 전체게시물 수를 구한다. ---- #
	$query = $query_select_count .
				$query_from .
				$query_where;
	$total_record = $DB->Value($query);
	$result = mysql_query($query,$DB->connect);
	//$total_record = @mysql_num_rows($result);

//echo $total_record;exit;
	# ---- 페이징변수 처리 (총 레코드수, 현재페이지번호, 페이지당 레코드수, 페이지블럭당 페이지 수) ---- #
    $board->Paging($total_record, $page, $cf_num_per_page, $cf_page_per_block);

	# ---- 전체 출력할 레코드를 가져온다. ---- #
	$query_limit = "LIMIT $board->first, $board->record_count";
	$query = $query_select .
				$query_from .
				$query_where .
				$query_order .
				$query_limit;
	//echo $query;exit;
	$arr = $DB->Pipe_Arr($query);

	// ------------------------------------------------------------ //
	//	출력할 레코드처리 시작


	// 게시물의 가상번호(게시물의 개수에 따른 일련번호)
	$article_num = $total_record - $cf_num_per_page * ($page - 1);
	$loop_cnt = 0;

	// 구매자이름 / 수령자이름/ 주문번호/ 장바구니번호 / 전화번호 / 핸드폰번호 / 주소 / 메모 / 금액 / 상품명 / 구매자닉네임

		$excel = "<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>";
		$excel = $excel."<table width=100% cellpadding=0 cellspacing=0 border=1 bordercolor='black'>";
		$excel = $excel."<tr align=center height=23>";
		$excel = $excel."<td align='center'>아이디</td>";
		$excel = $excel."<td  align='center'>성명</td>";
		$excel = $excel."<td  align='center'>주소</td>";
		$excel = $excel."<td  align='center'>휴대폰번호</td>";
		$excel = $excel."<td  align='center'>주문건</td>";		
		$excel = $excel."<td  align='center'>이메일주소</td>";
		$excel = $excel."<td  align='center'>가입일</td>";		
		$excel = $excel."</tr>";

	// 실제 출력 레코드변수 설정
	for($i=0; $i<$board->record_count; $i++)
	{

		$query2 = "select COUNT(SEQ)  from MT_ORDER_T where INPUT_ID='".$arr[$i][CM_ID]."'AND ( PROGRESS = '02' or PROGRESS = '03' or PROGRESS = '04' or PROGRESS = '05'  )";
		$total_record2 = $DB->Value($query2);

		if($total_record2>0){
			$order_cnt = $total_record2."건";
		}else{
			$order_cnt = "";
		}

		$INPUT_YMDHMS = substr($arr[$i][INPUT_YMDHMS],0,4)."-".substr($arr[$i][INPUT_YMDHMS],4,2)."-".substr($arr[$i][INPUT_YMDHMS],6,2);

		$excel = $excel."<tr align=center valign=middle>";
			$excel = $excel."<td align='center' valign=middle style='mso-number-format:\@;'>".$arr[$i][CM_ID]."</td>";
			$excel = $excel."<td align='center' valign=middle>".$arr[$i][CM_NM]."</td>";
			$excel = $excel."<td align='center' valign=middle>".$arr[$i][CM_ZIP_CD]." ".$arr[$i][CM_ADDR]." ".$arr[$i][CM_ADDR2]."</td>";
			$excel = $excel."<td align='center' valign=middle>".$arr[$i][CM_HP_TEL]."</td>";
			$excel = $excel."<td align='center' valign=middle>".$order_cnt."</td>";
			$excel = $excel."<td align='center' valign=middle>".$arr[$i][CM_EMAIL]."</td>";
			$excel = $excel."<td align='center' valign=middle style='mso-number-format:\@;'>".$INPUT_YMDHMS."</td>";	
			$excel = $excel."</tr>";


		// 게시물 가상번호 감소
		$article_num--;
	}
	$excel = $excel."</table>";
		echo $excel;
	// ------------------------------------------------------------ //
	//	출력할 레코드처리 끝
	// ------------------------------------------------------------ //

?>